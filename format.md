# Описание формата сериализованных данных

## Общая структура

Сериализованные данные состоят из следующих основных частей (в порядке следования слева направо):
1. Версия сериализатора длиной один байт;
1. Список закодированных частей сериализованного значения;
1. Необязательный индикатор наличия дополнительных секций длиной один байт;
1. Необязательная секция указателей;
1. Необязательная секция циклических указателей;
1. Необязательная секция словарей ключи и/или значения которых являются указателями.

```
version encoded_values [ section_indicator ] [ ptr_section ] [ cycle_ptr_section ] [ ptr_map_section ]
```

Здесь и далее [] - обозначает наличие компонента 0 или 1 раз, {} - наличие компонента 0 или более раз.

## Список частей сериализованного значения

Сериализуемое значение в общем случае представляет собой ориентированных граф с циклами. Этот граф
разбивается на отдельные компоненты связности путём удаления рёбер - указателей. Каждый такой компонент
связности хранится как отдельное значение в секции encoded_values.

```
id type_id encoded_value { id type_id encoded_value }
```

где 
- id - идентификатор значения (длиной от 1 до 9 байт), 
- type_id - идентификатор типа сериализованного значения (длиной от 1 до 5 байт),
- encoded_value - байты сериализованного значения, структура которых зависит от его типа.

## Индикатор секций

Каждый бит индикатора определяет наличие соответствующей секции:

```
      бит секции циклов указателей
      |
00000PCM
     |  \ 
     |   бит секции словарей
      \ 
       бит секции указателей
```

## Секция указателей

Содержит список всех указателей в формате:

```
ptr_count ptr_id pointed_value_id { ptr_id pointed_value_id }
```

где
- ptr_count - число указателей (длиной от 1 до 9 байт);
- ptr_id - идентификатор самого указателя (длиной от 1 до 9 байт);
- pointed_value_id - идентификатор значения на которое указывает указатель (длиной от 1 до 9 байт).

## Секция циклических указателей

Содержит список указателей замыкающих циклы указателей в формате:

```
ptr_count last_ptr_id first_ptr_id { last_ptr_id first_ptr_id } 
```

где
- ptr_count - число указателей (длиной от 1 до 9 байт);
- last_ptr_id - идентификатор последнего указателя в цикле (длиной от 1 до 9 байт);
- first_ptr_id - идентификатор первого указателя в цикле (длиной от 1 до 9 байт);

## Структура закодированных данных

В зависимости от типа значения кодируются по разному

### nil

Кодируется одним байтом: `&H10`

### bool

Кодируется одним байтом: `&H03` для true значений и `&H01` для false значения.

### uint8 (byte)

Идентификатор типа (&H02 для встроенного типа), затем один байт значения:

128
```
&H02 &H80
```

## Композитные типы

### interface{}

Идентификатор типа (&H?? для встроенного типа interface{}), затем само кодированное содержимое:

```go
var x any
x  = true
// Кодируется как
// &H?? &H01 &H01
```